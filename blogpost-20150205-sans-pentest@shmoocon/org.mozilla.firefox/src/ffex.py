#!/usr/bin/env python
#-*- coding: utf-8 -*-
#
import os
import sys
import ffcache

cachedir = "SANS 2015 Shmoocon Challenge/question_assets/org.mozilla.firefox/files/mozilla/9tnld04f.default/Cache"#sys.argv[1]

for i in xrange(1, 4):
	with open(os.path.join(cachedir,"_CACHE_00%d_"%i), "rb") as f:
		for meta in ffcache.scan_cachefile(f, 512*(2**i)):
			print i, meta#['request']
sys.exit(1)

#Example 1 : Reading a meta-data header
f = open(os.path.join(cachedir,"_CACHE_001_"),"rb")
f.seek(4096)
headerdata = f.read(36)
meta = ffcache.parse_meta_header(headerdata)
print meta

#Example 2: Parsing Request data
requestdata = f.read(meta['requestsize']+meta['infosize'])
ffcache.parse_request_data(meta,requestdata)
print meta
print meta['request']
print meta['info']

#Example 3: Adding content info
ffcache.add_content_info(meta)
print meta['content-type']
print meta['content-encoding']
print meta['charset']

#Example 4: Scanning a single cache file
f = open(os.path.join(cachedir,"_CACHE_001_"),"rb")
for meta in ffcache.scan_cachefile(f,256):
	print meta['request']

#Example 5: Scanning an entire directory
for meta in ffcache.scan_cache(cachedir):
	print meta['request']

#Here are some sample queries you can try:
# Find all requests related to slashdot
for meta in ffcache.scan_cache(cachedir):
	if 'slashdot' in meta['request']:
		print meta['request']

# Find all large JPEG images
jpegs = (meta for meta in ffcache.scan_cache(cachedir)
		if meta['content-type'] == 'image/jpeg'
		and meta['datasize'] > 100000)

for j in jpegs: print j['request']
